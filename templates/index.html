<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voice Assistant</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
            background: linear-gradient(to bottom right, #2d2d2d, #000);
            color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container { display: flex; height: 90vh; width: 90%; }
        .sidebar {
            width: 200px; background: #111; padding: 10px;
            display: flex; flex-direction: column;
        }
        .sidebar h2 { margin-top: 0; }
        .sidebar button {
            background: #333; border: none; color: #fff; padding: 8px;
            margin-bottom: 6px; border-radius: 5px; cursor: pointer;
        }
        .sidebar button.active, .sidebar button:hover { background: #555; }
        .chat { flex: 1; display: flex; flex-direction: column;
            margin-left: 10px; background: #1e1e1e; border-radius: 8px; overflow: hidden; }
        #messages { flex: 1; padding: 10px; overflow-y: auto; }
        .message { margin-bottom: 10px; }
        .message.user { text-align: right; }
        .message.user .bubble { background: #2563eb; color: #fff; }
        .bubble { display: inline-block; padding: 8px 12px; border-radius: 10px; background: #333; }
        .input-area { display: flex; padding: 10px; border-top: 1px solid #333; }
        .input-area input {
            flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #555;
            background: #222; color: #fff;
        }
        .input-area button {
            margin-left: 5px; padding: 8px 12px; border: none;
            border-radius: 5px; background: #2563eb; color: #fff; cursor: pointer;
        }
        .input-area button:hover { background: #1d4ed8; }
    </style>
</head>
<body>
<div class="container">
    <aside class="sidebar">
        <h2>Chats</h2>
        <div id="chats" class="list"></div>
        <button id="new-btn">New Chat</button>
    </aside>
    <main class="chat">
        <div id="messages"></div>
        <div class="input-area">
            <input id="input" type="text" placeholder="Ask something...">
            <button id="speak-btn">Speak</button>
            <button id="send-btn">Send</button>
        </div>
    </main>
</div>
<script>
(function(){
  const chatsEl = document.getElementById('chats');
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send-btn');
  const speakBtn = document.getElementById('speak-btn');
  const newBtn = document.getElementById('new-btn');

  let threads = JSON.parse(localStorage.getItem('threads') || '[]');
  let current = threads.length ? threads.length - 1 : null;

  function save(){ localStorage.setItem('threads', JSON.stringify(threads)); }

  function renderChats(){
    chatsEl.innerHTML = '';
    threads.forEach((t,i)=>{
      const b = document.createElement('button');
      b.textContent = 'Chat ' + (i+1);
      if(i===current) b.classList.add('active');
      b.onclick = () => { current = i; render(); };
      chatsEl.appendChild(b);
    });
  }

  function renderMessages(){
    messagesEl.innerHTML = '';
    const msgs = current === null ? [] : threads[current].messages;
    msgs.forEach(m => {
      const wrap = document.createElement('div');
      wrap.className = 'message ' + m.type;
      const div = document.createElement('div');
      div.className = 'bubble';
      div.textContent = m.content;
      wrap.appendChild(div);
      messagesEl.appendChild(wrap);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function render(){
    renderChats();
    renderMessages();
    save();
  }

  function newChat(){
    threads.push({id: Date.now(), messages: []});
    current = threads.length - 1;
    render();
  }

  function addMessage(msg){
    if(current === null) return;
    threads[current].messages.push(msg);
    render();
  }

  function send(){
    const text = inputEl.value.trim();
    if(!text || current === null) return;
    addMessage({type: 'user', content: text});
    inputEl.value = '';
    fetch('/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: text})
    }).then(r => r.json()).then(d => {
      addMessage({type: 'ai', content: d.response});
    }).catch(()=>{
      addMessage({type: 'ai', content: 'Error'});
    });
  }

  function dictate(){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition) return;
    const rec = new SpeechRecognition();
    rec.lang = 'en-US';
    rec.onresult = (e) => { inputEl.value = e.results[0][0].transcript; };
    rec.start();
  }

  sendBtn.onclick = send;
  speakBtn.onclick = dictate;
  newBtn.onclick = newChat;
  inputEl.addEventListener('keydown', e => { if(e.key === 'Enter') send(); });

  render();
})();
</script>
</body>
</html>
